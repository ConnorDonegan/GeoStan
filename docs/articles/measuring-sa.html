<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Measuring, visualizing, and simulating spatial autocorrelation • geostan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Measuring, visualizing, and simulating spatial autocorrelation">
<meta property="og:description" content="geostan">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/measuring-sa.html">Measuring, visualizing, and simulating spatial autocorrelation</a>
    </li>
    <li>
      <a href="../articles/modeling-spatial-data-with-geostan.html">Modeling spatial data</a>
    </li>
    <li>
      <a href="../articles/setting-priors.html">Setting prior distributions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Measuring, visualizing, and simulating spatial autocorrelation</h1>
                        <h4 class="author">Connor Donegan</h4>
            
      
      
      <div class="hidden name"><code>measuring-sa.Rmd</code></div>

    </div>

    
    
<p>This vignette covers basic usage of the <strong>geostan</strong> package for measuring, visualizing, and simulating spatial autocorrelation (SA) or systematic spatial patterns in the level of a variable. Positive SA is the tendency for nearby values to be more similar than distant values (i.e. clustering) while negative SA is the tendency for values to be located some distance away from others like them (i.e. repulsion).</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>Start by loading the <strong>geostan</strong>, <strong>sf</strong>, and <strong>ggplot2</strong> packages into your R environment along with the <code>ohio</code> dataset:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">geostan</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">ohio</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/ohio.html">geostan::ohio</a></code> is a simple features object with county-level Presidential vote shares compiled by the MIT Election Data and Science Lab (2018) and joined to some county characteristics. The data was analyzed using <strong>geostan</strong> in Donegan et al. (2020). The dataset includes growth in the Republican (GOP) share of Presidential votes from the average preceding elections (2000-2012) to 2016 (<code>gop_growth</code>). Thus positive values of <code>gop_growth</code> indicate places where Trump improved upon the previous GOP performance and negative values show where he performed worse:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ohio</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">gop_growth</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-3-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
<div id="spatial-weights-matrices" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-weights-matrices" class="anchor"></a>Spatial weights matrices</h2>
<p>All of the spatial diagnostics and models in <strong>geostan</strong> require a spatial connectivity matrix. You can make a connectivity matrix by passing a <code>SpatialPolygons</code> or <code>sf</code> object to <code><a href="../reference/shape2mat.html">geostan::shape2mat</a></code>. (It mainly wraps around a couple functions from the <strong>spdep</strong> package). The second argument to <code><a href="../reference/shape2mat.html">geostan::shape2mat</a></code> is the scheme for encoding connectivity—“B”, the default, produces a binary scheme (1 for neighbors, else 0) and “W” is row-standardized.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">ohio</span>, <span class="st">"B"</span><span class="op">)</span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">ohio</span>, <span class="st">"W"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">W</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
<p>The <code><a href="../reference/shape2mat.html">geostan::shape2mat</a></code> function can also create space-time connectivity matrices which many <strong>geostan</strong> functions will accept without any further modification—but you must ensure your data is properly ordered in space and time to match the connectivity matrix.</p>
</div>
<div id="measuring-spatial-autocorrelation" class="section level2">
<h2 class="hasAnchor">
<a href="#measuring-spatial-autocorrelation" class="anchor"></a>Measuring spatial autocorrelation</h2>
<p><strong>geostan</strong> has the following functions for measuring spatial autocorrelation:</p>
<ul>
<li>the Moran scatter plot <code><a href="../reference/moran_plot.html">geostan::moran_plot</a></code>.</li>
<li>the Moran coefficient <code><a href="../reference/mc.html">geostan::mc</a></code>,</li>
<li>local indicator of spatial autocorrelation <code><a href="../reference/lisa.html">geostan::lisa</a></code>,</li>
<li>the APLE statistic <code><a href="../reference/aple.html">geostan::aple</a></code> (Approximate Profile Likelihood Estimator of the spatial autocorrelation parameter from a simultaneous autoregressive model). Note that the <code>aple</code> is an approximation that is only valid for relatively small sample sizes.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>
</li>
</ul>
<p>When using the row-standardized spatial weights matrix, the Moran plot will show the original values <code>y</code> after being centered—<code>y.c = y - mean(y)</code>—plotted against the mean spatially-lagged value (<code>W %*% y.c</code>):<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">ohio</span><span class="op">$</span><span class="va">gop_growth</span>
<span class="fu"><a href="../reference/moran_plot.html">moran_plot</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">W</span><span class="op">)</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-5-1.png" width="336" style="display: block; margin: auto;"> If instead, we use the binary coding scheme for the spatial weights matrix <code>C</code> then the y-axis (<code>C * y.c</code>) would show the <em>sum</em> of spatially-lagged values.</p>
<p>The Moran plot is divided into quadrants, which lends points in each quadrant the following interpretation:</p>
<ul>
<li>Points in the upper-right (1st) quadrant are above-average values surrounded by above-average values (positive SA);</li>
<li>Points in the upper-left (2nd) quadrant are below-average values surrounded by above-average values (negative SA);</li>
<li>Points in the bottom-left (3rd) quadrant are below-average values surrounded by below-average values (positive SA);</li>
<li>Points in the bottom-right (4th) quadrant are above-average values surrounded by below-average values (negative (SA).</li>
</ul>
<p>Each point is thus a local indicator of spatial autocorrelation (LISA) which are often mapped to identify areas of high or low SA. Following Anselin (1995, Equation 7), the LISA values are simply the product of the value on the x-axis with their corresponding y-axis value; and the mean of all LISAs is proportionate to the Moran coefficient.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Lisa</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/lisa.html">lisa</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">W</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Lisa</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.5220273</span>
<span class="fu"><a href="../reference/mc.html">mc</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">W</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.528</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ohio</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">Lisa</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-6-1.png" width="336" style="display: block; margin: auto;"></p>
<p><code><a href="../reference/aple.html">geostan::aple</a></code> requires the row-standardized spatial weights matrix, and arguably provides a more intuitive estimate of the degree of SA since the SAR model can be used to generate spatially autocorrelated data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/aple.html">aple</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">W</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.796</span></code></pre></div>
<p>Again, for large number of observations the APLE approximation will break down.</p>
</div>
<div id="simulating-spatially-autocorrelated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulating-spatially-autocorrelated-data" class="anchor"></a>Simulating spatially autocorrelated data</h2>
<p>You can simulate data from the simultaneous autoregressive model (SAR) using the <code><a href="../reference/sim_sar.html">geostan::sim_sar</a></code> function and providing, at minimum, a row-standardized spatial weights matrix <code>w</code> and the degree of SA, <code>rho</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_sar.html">sim_sar</a></span><span class="op">(</span>w <span class="op">=</span> <span class="va">W</span>, rho <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span>

<span class="fu"><a href="../reference/aple.html">aple</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">W</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.681</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ohio</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-8-1.png" width="336" style="display: block; margin: auto;"> By default <code><a href="../reference/sim_sar.html">geostan::sim_sar</a></code> will return a single n-length draw from the multivariate normal model (with covariance matrix specified following the SAR model). By setting the argument <span class="math inline">\(m\)</span> to an integer value greater than one <code>sim_sar</code> will return an <span class="math inline">\(m \times n\)</span> matrix, with each row holding an n-length draw from the SAR model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_sar.html">sim_sar</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">5</span>, w <span class="op">=</span> <span class="va">W</span>, rho <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>
<span class="co">#&gt; [1]  5 88</span>
<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="va">aple</span>, w <span class="op">=</span> <span class="va">W</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.461 0.778 0.695 0.613 0.723</span></code></pre></div>
</div>
<div id="spatial-diagnostics-with-sp_diag" class="section level2">
<h2 class="hasAnchor">
<a href="#spatial-diagnostics-with-sp_diag" class="anchor"></a>Spatial diagnostics with <code>sp_diag</code>
</h2>
<p><code><a href="../reference/sp_diag.html">geostan::sp_diag</a></code> provides visual diagnostics for spatial data:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">ohio</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-10-1.png" width="624" style="display: block; margin: auto;"></p>
<p>It can also be used for analysis of model residuals. Here we model the mean and variance of <code>gop_growth</code> using a Gaussian probability distribution: <span class="math display">\[\begin{equation}
  y \sim \text{Gaussian}(\mu, \sigma).
  \end{equation}\]</span></p>
<p>Calculating a probability distribution for parameters <span class="math inline">\(\mu, \sigma\)</span> requires an initial or prior probability be specified for each. By Bayes’ theorem, the probability of parameters <span class="math inline">\(\theta\)</span> conditional on the latest data <span class="math inline">\(D\)</span> and our initial information <span class="math inline">\(I\)</span> is proportional to the product of two terms: first, the probability of the observations conditional on <span class="math inline">\(\theta\)</span> and <span class="math inline">\(I\)</span>, and second, the initial probability of <span class="math inline">\(\theta\)</span> conditional on <span class="math inline">\(I\)</span> alone: <span class="math display">\[\begin{equation}
  p(\theta | D, I) \propto p(D | \theta,I) p(\theta|I).
\end{equation}\]</span></p>
<p>which is often stated as<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<p><span class="math display">\[\begin{equation}
 \text{Posterior probability} \propto \text{Likelihood} \times \text{Prior probability}
 \end{equation}\]</span></p>
<p>Here we will just use the priors provided by <strong>geostan</strong> (as printed out to the console):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">gop_growth</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">ohio</span>, refresh <span class="op">=</span> <span class="fl">0</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for intercept</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 12.488757925385</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for sigma</span>
<span class="co">#&gt; Student's t</span>
<span class="co">#&gt; Degrees of freedom: 10</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 12.488757925385</span></code></pre></div>
<p>To examine the residuals, <span class="math inline">\(y - \hat{\mu}\)</span>, pass the model to <code><a href="../reference/sp_diag.html">geostan::sp_diag</a></code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">ohio</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-12-1.png" width="624" style="display: block; margin: auto;"></p>
<p>The <strong>geostan</strong> model returns samples drawn from the posterior probability distribution of <span class="math inline">\(\mu\)</span> (fitted values), which can be accessed using <code><a href="https://rdrr.io/r/stats/fitted.values.html">fitted(fit)</a></code>. Here <span class="math inline">\(\hat{\mu}\)</span> represents the mean of the posterior distribution of the parameter <span class="math inline">\(\mu\)</span>. Thus the following code reproduces the above results, but more transparently:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="va">deviations</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">-</span> <span class="va">mu</span><span class="op">$</span><span class="va">mean</span>
<span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">deviations</span>, <span class="va">ohio</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-13-1.png" width="624" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co">## also the same:</span>
<span class="co">## mu &lt;- as.matrix(fit, pars = "fitted")</span>
<span class="co">## mu &lt;- apply(mu, 2, mean)</span>
<span class="co">## deviations &lt;- y - mu</span>
<span class="co">## sp_diag(deviations, ohio)</span></code></pre></div>
</div>
<div id="estimating-and-visualizing-sa-patterns" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-and-visualizing-sa-patterns" class="anchor"></a>Estimating and visualizing SA patterns</h2>
<p>The <strong>geostan</strong> package also provides the <code><a href="../reference/spatial.html">geostan::spatial</a></code> method for extracting the spatial trend component from fitted spatial models (<code><a href="../reference/stan_esf.html">geostan::stan_esf</a></code>, <code><a href="../reference/stan_icar.html">geostan::stan_icar</a></code>, and <code><a href="../reference/stan_car.html">geostan::stan_car</a></code>). Continuous data can be modeled using eigenvector spatial filtering (ESF) models. ESF models use a linear combination of the eigenvectors <span class="math inline">\(E\)</span> of a transformed spatial connectivity matrix <span class="math inline">\(C\)</span> to identify SA patterns in the data. Each eigenvector contains a distinct map pattern which is indexed by the Moran coefficient (proportional to each respective eigenvalue). <strong>geostan</strong> assigns a horseshoe prior model to the parameter vector <span class="math inline">\(\beta_{E}\)</span>, reflecting our initial expectation that a relatively small number of eigenvectors will be sufficient to describe the SA patterns in the data. The result is a spatially varying mean <span class="math inline">\(\mu_i\)</span>:</p>
<p><span class="math display">\[\begin{equation}
  \mu_i = \alpha + E_i * \beta_{EV}
\end{equation}\]</span></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.esf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_esf.html">stan_esf</a></span><span class="op">(</span><span class="va">gop_growth</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">ohio</span>, C <span class="op">=</span> <span class="va">C</span>, refresh <span class="op">=</span> <span class="fl">0</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for intercept</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 12.488757925385</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for sigma</span>
<span class="co">#&gt; Student's t</span>
<span class="co">#&gt; Degrees of freedom: 10</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 12.488757925385</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for rhs</span>
<span class="co">#&gt; Global shrinkage prior (scale_global): 1</span>
<span class="co">#&gt; Slab degrees of freedom: 15</span>
<span class="co">#&gt; Slab scale: 29.1218447680832</span>
<span class="fu"><a href="../reference/sp_diag.html">sp_diag</a></span><span class="op">(</span><span class="va">fit.esf</span>, <span class="va">ohio</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span>
<span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-14-1.png" width="624" style="display: block; margin: auto;"> The residuals are no longer auto-correlated (a small negative MC value is expected). Instead, the autocorrelation structure has been shifted to the spatial filter. We can extract the spatial filter with the <code>spatial</code> method:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mu.esf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial.html">spatial</a></span><span class="op">(</span><span class="va">fit.esf</span><span class="op">)</span><span class="op">$</span><span class="va">mean</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">ohio</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">mu.esf</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="measuring-sa_files/figure-html/unnamed-chunk-15-1.png" width="336" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Anselin, Luc (1995). “Local indicators of spatial association—LISA.” <em>Geographical Analysis</em> 27, no. 2: 93-115.</p>
<p>Berliner, L. Mark (1996). “Hierarchical Bayesian time-series models” in <em>Maximum Entropy and Bayesian Methods,</em> Eds. Hanson, Kenneth M. and Silver, Richard N. Springer Netherlands.</p>
<p>Bivand R, Wong DWS (2018). “Comparing implementations of global and local indicators of spatial association.” <em>TEST</em>, 27(3), 716–748. <a href="https://doi.org/10.1007/s11749-018-0599-x" class="uri">https://doi.org/10.1007/s11749-018-0599-x</a>.</p>
<p>Chun, Yongwan, and Daniel A. Griffith (2013). <em>Spatial statistics and geostatistics: theory and applications for geographic information science and technology</em>. Sage.</p>
<p>Cressie, Noel and Wikle, Christopher K. (2011). <em>Statistics for Spatio-Temporal Data.</em> Wiley.</p>
<p>Donegan, Connor, Yongwan chun and Amy E. Hughes (2020). “Bayesian estimation of spatial filters with Moran’s eigenvectors and hierarchical shrinkage priors.” <em>Spatial Statistics</em> 38: 100450. <a href="https://osf.io/fah3z/">https://osf.io/fah3z/</a> Data and code: <a href="https://github.com/ConnorDonegan/ESF">https://github.com/ConnorDonegan/ESF</a>.</p>
<p>Jeffreys, Sir Harold (1961). <em>Theory of Probability.</em> Oxford University Press.</p>
<p>Li, Hongfei, Catherine A. Calder, and Noel Cressie (2007). “Beyond Moran’s I: testing for spatial dependence based on the spatial autoregressive model.” <em>Geographical Analysis</em> 39, no. 4: 357-375.</p>
<p>MIT Election Data and Science Lab (2018). “County Presidential Election Returns 2000-2016”, URL:<a href="https://doi.org/10.7910/DVN/VOQCHQ" class="uri">https://doi.org/10.7910/DVN/VOQCHQ</a>, Harvard Dataverse, V1.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>As a rough rule of thumb, if you have to wait for the <code>aple</code> to calculate, you should be using a different measure.<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>Using centered data <span class="math inline">\(y_c\)</span> and its spatial lag <span class="math inline">\(\tilde{y_c} = W * y_c\)</span>, the Moran coefficient is equal to a scale factor <span class="math inline">\(\frac{n}{1'C1}\)</span> times <span class="math inline">\(\hat{\beta}\)</span> from a bivariate regression of the spatial lag of <span class="math inline">\(y_c\)</span> on itself, where <span class="math inline">\(1\)</span> a column vector of ones (i.e. the denominator is the sum of the row sums of the connectivity matrix.) For a row-standardized matrix <span class="math inline">\(\frac{n}{1'C1} = 1\)</span>. Moran’s I can be written as <span class="math inline">\(I = \frac{n}{1'C1}\frac{Cov(y_c, \tilde{y_c})}{Var(y_c)} = \frac{n}{1'C1}\hat{\beta}\)</span>.<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>For more complex models such as the spatial models availabe in <strong>geostan</strong>, a more natural notation is Posterior probability <span class="math inline">\(\propto\)</span> [Process model] <span class="math inline">\(\times\)</span> [Parameter model], which recognizes that the prior can itself be a complex model. This generalizes further to incorporate models of observational error: Posterior probability <span class="math inline">\(\propto\)</span> [Data model] <span class="math inline">\(\times\)</span> [Process model] <span class="math inline">\(\times\)</span> [Parameter model] (Berliner 1996; Cressie and Wikle 2011), which is implemented in geostan models through the <code>ME</code> argument.<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
