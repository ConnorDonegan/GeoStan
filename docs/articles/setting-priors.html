<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Setting prior distributions • geostan</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Setting prior distributions">
<meta property="og:description" content="geostan">
<meta property="og:image" content="https://connordonegan.github.io/geostan/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-116873024-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-116873024-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">geostan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/measuring-sa.html">Measuring, visualizing, and simulating spatial autocorrelation</a>
    </li>
    <li>
      <a href="../articles/setting-priors.html">Setting prior distributions</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ConnorDonegan/geostan/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Setting prior distributions</h1>
                        <h4 class="author">Connor Donegan</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ConnorDonegan/geostan/blob/master/vignettes/setting-priors.Rmd"><code>vignettes/setting-priors.Rmd</code></a></small>
      <div class="hidden name"><code>setting-priors.Rmd</code></div>

    </div>

    
    
<p>This vignette provides instruction for setting prior distributions for <strong>geostan</strong> models. While <strong>geostan</strong> will set priors automatically if you do not provide them, users are encouraged to set priors based on domain-specific knowledge.</p>
<div id="getting-started" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting started</h2>
<p>Load the <strong>geostan</strong>, <strong>ggplot2</strong>, and <strong>sf</strong> packages:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://connordonegan.github.io/geostan">geostan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>  
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span></code></pre></div>
<p>Given a url to a shapefile, the <code><a href="../reference/get_shp.html">geostan::get_shp</a></code> function will download the data and unzip it into your working directory. Download the <code>nepal</code> dataset with information on social indicators for 75 districts of Nepal (hosted by <a href="https://geodacenter.github.io/">GeoDa</a>):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># saving to a temporary directory</span>
<span class="va">folder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://geodacenter.github.io/data-and-lab//data/nepal.zip"</span>
<span class="fu"><a href="../reference/get_shp.html">get_shp</a></span><span class="op">(</span><span class="va">url</span>, <span class="va">folder</span><span class="op">)</span>
<span class="co">#&gt; [1] "/tmp/RtmpXB3nIN/file5c4416652df65"    </span>
<span class="co">#&gt; [2] "/tmp/RtmpXB3nIN/file5c44168a00bef"    </span>
<span class="co">#&gt; [3] "/tmp/RtmpXB3nIN/file5c441790014b6.zip"</span>
<span class="co">#&gt; [4] "/tmp/RtmpXB3nIN/file5c441afecd34.so"  </span>
<span class="co">#&gt; [5] "/tmp/RtmpXB3nIN/nepal.dbf"            </span>
<span class="co">#&gt; [6] "/tmp/RtmpXB3nIN/nepal.prj"            </span>
<span class="co">#&gt; [7] "/tmp/RtmpXB3nIN/nepal.shp"            </span>
<span class="co">#&gt; [8] "/tmp/RtmpXB3nIN/nepal.shx"</span>
<span class="va">nepal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="va">folder</span>, <span class="st">"nepal"</span><span class="op">)</span>
<span class="co">#&gt; Reading layer `nepal' from data source `/tmp/RtmpXB3nIN' using driver `ESRI Shapefile'</span>
<span class="co">#&gt; Simple feature collection with 75 features and 61 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 80.06014 ymin: 26.34752 xmax: 88.20401 ymax: 30.44702</span>
<span class="co">#&gt; Geodetic CRS:  WGS 84</span></code></pre></div>
<p>We will reference per-capita income (PCI) <code>pcinc</code> and the percentage of people not expected to survive beyond age 40 <code>lif40</code> (or “early mortality”). To work with a fixed example, consider a model that hypothesizes premature mortality rates to be a linear function of per-capita income <span class="math display">\[\begin{equation}
 \text{early_mortality}_i = \alpha + \beta * \text{PCI}_i + e_i
 \end{equation}\]</span> with <span class="math inline">\(e_i\)</span> an error term, and we want to obtain a probability distribution for each of the model’s parameters conditional on the <code>nepal</code> data and background information. Note that the examples here are intended only to provide guidance on how to use particular features in the software, this vignette does not offer guidance on determining what prior parameters are appropriate.</p>
</div>
<div id="default-prior-distributions" class="section level2">
<h2 class="hasAnchor">
<a href="#default-prior-distributions" class="anchor"></a>Default prior distributions</h2>
<p>If you don’t provide prior distributions <strong>geostan</strong> will set them for you and will print them out before fitting the model:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"> <span class="co"># refresh = 0 suppresses some of the printing from Stan</span>
<span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span>, refresh <span class="op">=</span> <span class="fl">0</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for intercept</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 4.35003116898847</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for beta</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt;       Location      Scale</span>
<span class="co">#&gt; pcinc        0 0.01586476</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for sigma</span>
<span class="co">#&gt; Student's t</span>
<span class="co">#&gt; Degrees of freedom: 10</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 4.35003116898847</span></code></pre></div>
<p>The intercept and coefficients are assigned Gaussian prior distributions centered on zero with scale parameter equal to <span class="math inline">\(2 * s_y\)</span> and <span class="math inline">\(2*\frac{s_y}{s_x}\)</span> respectively (with <span class="math inline">\(s\)</span> the sample standard deviation; similar to the default priors in the <strong>rstanarm</strong> package). For models with a Gaussian or Student’s <span class="math inline">\(t\)</span> likelihood, the scale parameter <span class="math inline">\(\sigma\)</span> for the outcome is assigned a half-Student’s <span class="math inline">\(t\)</span> model (truncated to be positive) with scale <span class="math inline">\(2 * s_y\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">$</span><span class="va">lif40</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">$</span><span class="va">pcinc</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.01586476</span></code></pre></div>
<p>By setting <code>prior_only = TRUE</code> we tell Stan to sample from the prior distributions only, ignoring the likelihood of the data. We can visualize samples from the prior distributions:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="setting-priors_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"> We can also extract all the samples from prior distributions as a matrix:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">beta.samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">fit</span>, pars <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta.samples</span><span class="op">)</span>
<span class="co">#&gt; [1] 8000    1</span></code></pre></div>
<p>If we use the <code>centerx</code> (or <code>scalex</code>) arguments in <code>stan_glm</code> (or any of the <strong>geostan</strong> model fitting functions), the covariates will be centered (or scaled) before the priors are calculated, and the default prior for the intercept will be centered on the data mean <span class="math inline">\(\bar{y}\)</span> rather than zero:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit.c</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, centerx <span class="op">=</span> <span class="cn">TRUE</span>, refresh <span class="op">=</span> <span class="fl">0</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for intercept</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt; Location: 8.27733333333333</span>
<span class="co">#&gt; Scale: 4.35003116898847</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for beta</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt;       Location      Scale</span>
<span class="co">#&gt; pcinc        0 0.01586476</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for sigma</span>
<span class="co">#&gt; Student's t</span>
<span class="co">#&gt; Degrees of freedom: 10</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 4.35003116898847</span></code></pre></div>
<p>Centering or scaling data often improves Stan’s sampling speed, sometimes dramatically!</p>
</div>
<div id="setting-priors-glm" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-priors-glm" class="anchor"></a>Setting priors: GLM</h2>
<p>This section shows how to set priors on the intercept, coefficients, scale term <span class="math inline">\(\sigma\)</span>, and other parameters that apply to some or all of the <code>stan_*</code> model fitting functions. The prior models are fixed (i.e. you currently cannot change the prior on the intercept from a Gaussian to Student’s <span class="math inline">\(t\)</span>) but you can and generally should provide your own values for the parameters.</p>
<div id="intercept" class="section level3">
<h3 class="hasAnchor">
<a href="#intercept" class="anchor"></a>Intercept</h3>
<p>To set the prior parameters for the intercept provide the values for the location <span class="math inline">\(\mu\)</span> and scale <span class="math inline">\(\sigma\)</span> of the Gaussian distribution to the <code>prior_intercept</code> argument. The following code sets the prior for the intercept to a Gaussian distribution with mean 0 and scale 5:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, prior_intercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="coefficients" class="section level3">
<h3 class="hasAnchor">
<a href="#coefficients" class="anchor"></a>Coefficients</h3>
<p>Priors for coefficients need to be provided in a matrix or data frame and passed to the <code>prior</code> argument. Provide two columns—location and scale—and a row for each variable in their order of appearance in the model formula. In this case there is one variable, so if we wish to set its prior to a Gaussian with mean 2 and scale 2 we would use:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">2</span>, scale <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>If we had two covariates and wished to assigned the same prior to all of them the <code>prior</code> argument would then look like <code>prior = data.frame(location = c(2, 2), scale = c(2, 2))</code>.</p>
</div>
<div id="outcome-scale" class="section level3">
<h3 class="hasAnchor">
<a href="#outcome-scale" class="anchor"></a>Outcome scale</h3>
<p>The scale parameter <span class="math inline">\(\sigma\)</span> is assigned a half-Student’s <span class="math inline">\(t\)</span> prior, which is truncated at zero (i.e. only positive values will be assigned non-zero probability). The Student’s <span class="math inline">\(t\)</span> distribution has three parameters: degrees of freedom, location, and scale. So if we wish to set the prior to Student’s <span class="math inline">\(t\)</span> with 10 degrees of freedom, location 0, and scale 2, we would provide the following:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, prior_sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="students-t-likelihood" class="section level3">
<h3 class="hasAnchor">
<a href="#students-t-likelihood" class="anchor"></a>Student’s <span class="math inline">\(t\)</span> likelihood</h3>
<p>Often times the Gaussian model is unsatisfactory because there appear to be ‘outliers’ that may be exerting undue influence on the results. Since the Student’s <span class="math inline">\(t\)</span> likelihood has heavier tails, such outliers will exert less influence when <code>family = student_t()</code>. The prior for the degrees of freedom for the likelihood is a Gamma distribution and it can be set using the <code>prior_nu</code> argument in <code>stan_glm</code>. The default, for instance, could be set manually like this:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/student_t.html">student_t</a></span><span class="op">(</span><span class="op">)</span>, prior_nu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>which for reference looks like this:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">30e3</span>, <span class="fl">3</span>, <span class="fl">0.2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span><span class="op">(</span><span class="va">g</span>, main <span class="op">=</span> <span class="st">"Gamma(3, 0.2)"</span><span class="op">)</span></code></pre></div>
<p><img src="setting-priors_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div id="varying-intercepts" class="section level3">
<h3 class="hasAnchor">
<a href="#varying-intercepts" class="anchor"></a>Varying intercepts</h3>
<p>All of the models have the option to include a varying intercept term. These are similar to adding an indicator or dummy variable for each region, for instance, or any other geographic scale. However, they use hierarchical modeling to partially pool information across observations (often called ‘random effects’ terms, which is misleading). For count data especially, this offers a way to evaluate rates of occurrence while remaining attentive to the instability of rates when denominators are small. Generically, these models assign low probability to ‘extreme’ values, but what is considered ‘extreme’ or implausible is defined by a Gaussian distribution with parameters that are inferred from the data. The varying intercepts <span class="math inline">\(\alpha_{[j]}\)</span> are deviations from the global intercept, and their prior model is equivalent to: <span class="math display">\[
\alpha_{[j]} \sim Gauss(0, \tau_\alpha) \\
\tau_\alpha \sim Student^{+}(\text{degrees of freedom, location, scale})
\]</span> with positively-constrained Student’s <span class="math inline">\(t\)</span> prior for the scale. If we were to estimate the mean <code>lif40</code> for each of the 14 regions in the <code>nepal</code> data (found in the <code>name_2</code> variable), we would use the <code>re</code> argument to specify the regional grouping variable and override the default prior parameters for <span class="math inline">\(\alpha_\tau\)</span>, if desired, using the <code>prior_tau</code> argument:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_glm.html">stan_glm</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="fl">1</span>, re <span class="op">=</span> <span class="op">~</span> <span class="va">name_2</span>, data <span class="op">=</span> <span class="va">nepal</span>, prior_tau <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">15</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="setting-priors-car" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-priors-car" class="anchor"></a>Setting priors: CAR</h2>
<p>The only adjustable parameter specific to the CAR model is the prior on the scale parameter. The default is weakly informative. The CAR model is a multivariate Gaussian distribution specified as followings:</p>
<p><span class="math display">\[ Y \sim MVGauss(\mu, (I - \rho C) M) \]</span></p>
<p>where <span class="math inline">\(Y\)</span> is a vector of parameters or data to model. With <span class="math inline">\(M = \Delta \sigma^2\)</span>, <span class="math inline">\(\Delta\)</span> is a diagonal matrix with known positive values on the diagonal that are proportional to the conditional variances of each respective observation (<code>conditional' meaning, 'conditional on knowing the values of the neighboring observations'), and $sigma^2$ is a scale parameter. C is a connectivity matrix and $\rho$ is a spatial dependence parameter, capturing the nature and degree of autocorrelation. The</code>geostan::prep_car_data` function provides a convenient method of producing <span class="math inline">\(M\)</span> and <span class="math inline">\(C\)</span>.</p>
<p>The scale parameter <span class="math inline">\(\sigma\)</span> is given a half-Student’s t prior (“half” meaning it is constrained to positive values only), requiring parameters for degrees of freedom, location, and scale. The following code sets the prior to 30 degrees of freedom, location 0, and unit scale:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_car.html">stan_car</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="va">log_population</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span>, C <span class="op">=</span> <span class="va">C</span>, prior_car_scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="setting-priors-icar" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-priors-icar" class="anchor"></a>Setting priors: ICAR</h2>
<p>The Intrinsic Conditional Autoregressive (ICAR) models are based on the Stan code developed in <span class="citation">Morris et al. (2019)</span>. In each of the available model options (<code>type = c("icar", "bym", "bym2")</code>), a parameter vector <code>phi</code> is assigned the ICAR prior (which places high prior probability on smooth spatial trends). The model is fixed, with no priors available to set.</p>
<p>To implement the BYM2 model introduced in <span class="citation">Riebler et al. (2016)</span> and implemented in Stan by <span class="citation">Morris et al. (2019)</span>, you must provide an additional <code>scale_factor</code> term using the <strong>INLA</strong> package (see <a href="https://www.r-inla.org/download-install">here</a> for installation instructions).</p>
<p>The following code chunk demonstrates how to calculate the <code>scale_factor</code> argument given a spatial connectivity matrix C, the <code><a href="../reference/prep_icar_data.html">geostan::prep_icar_data</a></code> function, and a user-defined function <code>c_scale</code> (from <span class="citation">Morris et al. (2019)</span>):</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span>

<span class="co">#' create scale factor for BYM2 model</span>
<span class="co">#' C must be an N by N connectivity matrix</span>
<span class="va">c_scale</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">C</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span>
    <span class="va">adj.matrix</span> <span class="op">&lt;-</span> <span class="fu">Matrix</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html">Matrix</a></span><span class="op">(</span><span class="va">C</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="va">Q</span> <span class="op">=</span>  <span class="fu">Diagonal</span><span class="op">(</span><span class="va">N</span>, <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">adj.matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="va">adj.matrix</span>
    <span class="va">Q_pert</span> <span class="op">=</span> <span class="va">Q</span> <span class="op">+</span> <span class="fu">Diagonal</span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">Q</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span>
    <span class="va">Q_inv</span> <span class="op">=</span> <span class="fu">INLA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/qinv.html">inla.qinv</a></span><span class="op">(</span><span class="va">Q_pert</span>, constr<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="va">N</span><span class="op">)</span>,e<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span>
    <span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="va">Q_inv</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span> <span class="op">(</span><span class="va">scale_factor</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">)</span>
<span class="va">icar.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prep_icar_data.html">prep_icar_data</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span>

<span class="va">k</span> <span class="op">&lt;-</span> <span class="va">icar.data</span><span class="op">$</span><span class="va">k</span>
<span class="va">scale_factor</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span>mode <span class="op">=</span> <span class="st">"numeric"</span>, length <span class="op">=</span> <span class="va">k</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">k</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">g.idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">icar.data</span><span class="op">$</span><span class="va">comp.id</span> <span class="op">==</span> <span class="va">j</span><span class="op">)</span> 
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">g.idx</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
        <span class="va">scale_factor</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> 
        <span class="kw">next</span>
    <span class="op">}</span>    
    <span class="va">Cg</span> <span class="op">&lt;-</span> <span class="va">C</span><span class="op">[</span><span class="va">g.idx</span>, <span class="va">g.idx</span><span class="op">]</span> 
    <span class="va">scale.j</span> <span class="op">&lt;-</span> <span class="fu">c_scale</span><span class="op">(</span><span class="va">Cg</span><span class="op">)</span>
    <span class="va">scale_factor</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">scale.j</span>
<span class="op">}</span></code></pre></div>
<p>The <code>scale_factor</code> is then passed to <code>stan_icar</code> for the BYM2 model, as in:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_icar.html">stan_icar</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html">offset</a></span><span class="op">(</span><span class="va">log_population</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">data</span>, type <span class="op">=</span> <span class="st">"bym2"</span>, C <span class="op">=</span> <span class="va">C</span>, scale_factor <span class="op">=</span> <span class="va">scale_factor</span><span class="op">)</span></code></pre></div>
</div>
<div id="setting-priors-esf" class="section level2">
<h2 class="hasAnchor">
<a href="#setting-priors-esf" class="anchor"></a>Setting priors: ESF</h2>
<p>The eigenvector spatial filter (ESF) models (see <code><a href="../reference/stan_esf.html">geostan::stan_esf</a></code>) will also set priors automatically for the additional parameters needed to fit the spatial filter, specifically the coefficients <code>beta_ev</code> on the spatial eigenvectors. ESF models attempt to use a linear combination of the eigenvectors from a transformed spatial connectivity matrix to estimate latent spatial autocorrelation patterns. The Nepal model could be updated with a spatial filter as such: <span class="math display">\[\begin{equation}
  \text{early_mortality}_i = \alpha + EV_i * \beta_{EV} + \text{PCI}_i * \beta_{inc} + e_i
  \end{equation}\]</span> Each of the eigenvectors represent patterns of potential spatial autocorrelation. The challenge of ESF models is that they can have a very high number of parameters to estimate (one for each eigenvector) and often only a small number of them are far from zero. The <strong>geostan</strong> package assigns a regularized horseshoe (RHS) prior model (<span class="citation">Piironen and Vehtari (2017)</span>) to the coefficients <code>beta_ev</code>. This concentrates prior probability on zero, aggressively shrinking all of the coefficients to zero; but it also has heavy tails that open up where there is sufficient evidence of a non-zero coefficient, allowing a few parameters to escape the pull toward zero.</p>
<p>Again <strong>geostan</strong> will print its default priors before sampling from the model:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">C</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/shape2mat.html">shape2mat</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">)</span>
<span class="va">fit.esf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_esf.html">stan_esf</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, C <span class="op">=</span> <span class="va">C</span>, centerx <span class="op">=</span> <span class="cn">TRUE</span>, prior_only <span class="op">=</span> <span class="cn">TRUE</span>, refresh <span class="op">=</span> <span class="fl">0</span>, cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for intercept</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt; Location: 8.27733333333333</span>
<span class="co">#&gt; Scale: 4.35003116898847</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for beta</span>
<span class="co">#&gt; Gaussian</span>
<span class="co">#&gt;       Location      Scale</span>
<span class="co">#&gt; pcinc        0 0.01586476</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for sigma</span>
<span class="co">#&gt; Student's t</span>
<span class="co">#&gt; Degrees of freedom: 10</span>
<span class="co">#&gt; Location: 0</span>
<span class="co">#&gt; Scale: 4.35003116898847</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; *Setting prior parameters for rhs</span>
<span class="co">#&gt; Global shrinkage prior (scale_global): 1</span>
<span class="co">#&gt; Slab degrees of freedom: 15</span>
<span class="co">#&gt; Slab scale: 9.35509575935311</span></code></pre></div>
<p>We can plot samples from the prior distribution:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">fit.esf</span>, pars <span class="op">=</span> <span class="st">"beta_ev[1]"</span><span class="op">)</span>
<span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></code></pre></div>
<p><img src="setting-priors_files/figure-html/unnamed-chunk-19-1.png" width="576" style="display: block; margin: auto;"> We can also draw samples from prior distribution of the spatial filter itself, which is a joint probability over <code>EV * beta_ev</code>, using <code><a href="../reference/spatial.html">geostan::spatial</a></code>::</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spatial.html">spatial</a></span><span class="op">(</span><span class="va">fit.esf</span>, summary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>The new object <code>sf</code> is an <code>m</code>-by-<code>n</code> matrix, where <code>m</code> is the number of samples drawn from the posterior distribution and <code>n</code> is the number of observations in the data.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>
<span class="co">#&gt; [1] 4000   75</span></code></pre></div>
<p>Thus the <code>i</code>th column contains samples from the marginal (prior) probability distribution for the spatial filter (i.e. spatially varying mean) at the location of the <code>i</code>th observation. This means one can summarize the probability distribution for the spatial filter at the <code>i</code>th observation by manipulating <code>sf</code> column-wise:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># one at a time</span>
<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">sf</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.01060625</span>

<span class="co"># summarize them all: mean of each column</span>
<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">sf</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span>
<span class="co">#&gt;        esf[1]        esf[2]        esf[3]        esf[4]        esf[5] </span>
<span class="co">#&gt;  0.0106062468 -0.0585676143 -0.0471154913  0.0341042249 -0.0001138872 </span>
<span class="co">#&gt;        esf[6]        esf[7]        esf[8]        esf[9]       esf[10] </span>
<span class="co">#&gt;  0.0074838183  0.0136648868  0.0112120613 -0.0130083233  0.0369825776 </span>
<span class="co">#&gt;       esf[11]       esf[12]       esf[13]       esf[14]       esf[15] </span>
<span class="co">#&gt;  0.0347514235  0.0586690935  0.0030275274  0.0294317561  0.0124068741 </span>
<span class="co">#&gt;       esf[16]       esf[17]       esf[18]       esf[19]       esf[20] </span>
<span class="co">#&gt;  0.0204314887 -0.0022452081 -0.0203291066 -0.0456008880 -0.0449021459 </span>
<span class="co">#&gt;       esf[21]       esf[22]       esf[23]       esf[24]       esf[25] </span>
<span class="co">#&gt; -0.0367901412 -0.0348694077  0.0046571911 -0.0213042466  0.0085936656 </span>
<span class="co">#&gt;       esf[26]       esf[27]       esf[28]       esf[29]       esf[30] </span>
<span class="co">#&gt; -0.0542070453  0.0602005711 -0.0386176732  0.0807027470 -0.0481919478 </span>
<span class="co">#&gt;       esf[31]       esf[32]       esf[33]       esf[34]       esf[35] </span>
<span class="co">#&gt; -0.0563206950  0.0266081555  0.0771189689 -0.0555904624 -0.0411343268 </span>
<span class="co">#&gt;       esf[36]       esf[37]       esf[38]       esf[39]       esf[40] </span>
<span class="co">#&gt; -0.0205442670 -0.0048773351 -0.0087310271 -0.0510823668 -0.0571385721 </span>
<span class="co">#&gt;       esf[41]       esf[42]       esf[43]       esf[44]       esf[45] </span>
<span class="co">#&gt; -0.0596298415 -0.0288670501 -0.0305788856 -0.0100228353 -0.0265228798 </span>
<span class="co">#&gt;       esf[46]       esf[47]       esf[48]       esf[49]       esf[50] </span>
<span class="co">#&gt;  0.0143079881 -0.0598509187 -0.0459938188  0.0190447158  0.0025956864 </span>
<span class="co">#&gt;       esf[51]       esf[52]       esf[53]       esf[54]       esf[55] </span>
<span class="co">#&gt; -0.0025378317  0.0002073692 -0.0239733401 -0.0299466870  0.0229373875 </span>
<span class="co">#&gt;       esf[56]       esf[57]       esf[58]       esf[59]       esf[60] </span>
<span class="co">#&gt;  0.0177386896  0.0283222947  0.0340410549  0.0135682540  0.0234039449 </span>
<span class="co">#&gt;       esf[61]       esf[62]       esf[63]       esf[64]       esf[65] </span>
<span class="co">#&gt;  0.0135856877 -0.0166121909  0.0144068298  0.0085483454  0.0274162715 </span>
<span class="co">#&gt;       esf[66]       esf[67]       esf[68]       esf[69]       esf[70] </span>
<span class="co">#&gt;  0.0145365369 -0.0398222152  0.0832979764  0.0744993657 -0.0124238265 </span>
<span class="co">#&gt;       esf[71]       esf[72]       esf[73]       esf[74]       esf[75] </span>
<span class="co">#&gt;  0.0206096790  0.0621141609  0.0393855196  0.0731473995  0.0096960642</span></code></pre></div>
<p>By contrast, each row is a draw from the <em>joint</em> probability distribution of the spatial filter. Each of the coefficients has the same marginal probability as <code>beta_ev[1]</code>. But samples from the joint distribution show that the horseshoe prior assigns high probability to the presence of positive spatial autocorrelation (without favoring any particular pattern). Each of the samples exhibit a different pattern, arising from various linear combinations of eigenvectors:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n.samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>
<span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n.samples</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">sf</span><span class="op">[</span><span class="va">idx</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="setting-priors_files/figure-html/unnamed-chunk-23-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="va">n.samples</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">sf</span><span class="op">[</span><span class="va">idx</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html">scale_fill_gradient2</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="setting-priors_files/figure-html/unnamed-chunk-23-2.png" width="576" style="display: block; margin: auto;"> The default priors for <code><a href="../reference/stan_esf.html">geostan::stan_esf</a></code> are designed to work well for the data provided, but they are not perfect. The best evaluation of the ESF models is to examine the residuals for spatial autocorrelation using <code><a href="../reference/moran_plot.html">geostan::moran_plot</a></code> or <code><a href="../reference/sp_diag.html">geostan::sp_diag</a></code>.</p>
<p>The RHS model has three parameters that need to be set. First is a global scale parameter which should reflect our initial information on how sparse the model should be: setting <code>scale_global</code> near zero will impose more sparsity, and moving it towards 1 relaxes the sparsity of the model. If a model shows residual spatial autocorrelation, relaxing the degree of sparsity may help by allowing spatial filter to expand and absorb more of the autocorrelation pattern. Approximating the autocorrelation patterns in data with strong spatial autocorrelation typically requires greater numbers of eigenvectors, and this informs <strong>geostan</strong>’s default prior settings (based on equations from <span class="citation">Chun et al. (2016)</span>; see <span class="citation">Donegan, Chun, and Hughes (2020)</span>). The remaining parameters to set are the degrees of freedom and scale for a Student’s <span class="math inline">\(t\)</span> prior which is applied to any of the “large” parameter estimates that escape the shrinkage to zero. One can view the RHS model as a combination of a spike at zero and slabs extending outwards; the Student’s <span class="math inline">\(t\)</span> model determines the width of the slabs.</p>
<p>The RHS prior parameters can be set by providing a named vector to the <code>prior_rhs</code> argument, with elements <code>scale_global</code> and <code>slab_df</code> and <code>slab_scale</code> (for the Student’s <span class="math inline">\(t\)</span> slab):</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_esf.html">stan_esf</a></span><span class="op">(</span><span class="va">lif40</span> <span class="op">~</span> <span class="va">pcinc</span>, data <span class="op">=</span> <span class="va">nepal</span>, C <span class="op">=</span> <span class="va">C</span>, prior_rhs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>scale_global <span class="op">=</span> <span class="fl">0.6</span>, slab_df <span class="op">=</span> <span class="fl">10</span>, slab_scale <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>For some intuition on the scale of the slab, you have to know the scale of the eigenvectors and the outcome variable. All of the eigenvectors have the same scale, which in this case is:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">EV</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_EV.html">make_EV</a></span><span class="op">(</span><span class="va">C</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">EV</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt; [1] 0.1162476</span>

<span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">nepal</span><span class="op">$</span><span class="va">lif40</span><span class="op">)</span>
<span class="co">#&gt; [1] 2.175016</span></code></pre></div>
<p>The default prior for the slab is <code>slab_df = 15</code> and <code>slab_scale = 0.5 * sd(y) / sd(EV[,1])</code>. The default prior for the <code>scale_global</code> parameter is described in <span class="citation">Donegan, Chun, and Hughes (2020)</span>.</p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-chun_2016">
<p>Chun, Yongwan, Daniel A Griffith, Monghyeon Lee, and Parmanand Sinha. 2016. “Eigenvector Selection with Stepwise Regression Techniques to Construct Eigenvector Spatial Filters.” <em>Journal of Geographical Systems</em> 18 (1): 67–85.</p>
</div>
<div id="ref-donegan_2020">
<p>Donegan, Connor, Yongwan Chun, and Amy E Hughes. 2020. “Bayesian Estimation of Spatial Filters with Moran’s Eigenvectors and Hierarchical Shrinkage Priors.” <em>Spatial Statistics</em>, 100450.</p>
</div>
<div id="ref-morris_2019">
<p>Morris, Mitzi, Katherine Wheeler-Martin, Dan Simpson, Stephen J Mooney, Andrew Gelman, and Charles DiMaggio. 2019. “Bayesian Hierarchical Spatial Models: Implementing the Besag York Mollié Model in Stan.” <em>Spatial and Spatio-Temporal Epidemiology</em> 31: 100301. <a href="https://mc-stan.org/users/documentation/case-studies/icar_stan.html#bym2-improving-the-parameterization-of-the-besag-york-and-mollie-model">https://mc-stan.org/users/documentation/case-studies/icar_stan.html#bym2-improving-the-parameterization-of-the-besag-york-and-mollie-model</a>.</p>
</div>
<div id="ref-piironen_2017">
<p>Piironen, Juho, and Aki Vehtari. 2017. “Sparsity Information and Regularization in the Horseshoe and Other Shrinkage Priors.” <em>Electronic Journal of Statistics</em> 11 (2): 5018–51.</p>
</div>
<div id="ref-riebler_2016">
<p>Riebler, Andrea, Sigrunn H Sørbye, Daniel Simpson, and Håvard Rue. 2016. “An Intuitive Bayesian Spatial Model for Disease Mapping That Accounts for Scaling.” <em>Statistical Methods in Medical Research</em> 25 (4): 1145–65.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Connor Donegan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
